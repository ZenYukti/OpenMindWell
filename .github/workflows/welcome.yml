name: ZenYukti Welcome & Success Bot
on:
  pull_request_target:
    types: [opened, closed]
  issues:
    types: [opened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  zen_bot:
    runs-on: ubuntu-latest
    steps:
      - name: ZenYukti Automation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Define the Adaptive Banner
          BANNER='<picture><source media="(prefers-color-scheme: dark)" srcset="https://raw.githubusercontent.com/ZenYukti/zenyukti.github.io/main/public/assets/branding/gh-dark.png"><source media="(prefers-color-scheme: light)" srcset="https://raw.githubusercontent.com/ZenYukti/zenyukti.github.io/main/public/assets/branding/gh-bright.png"><img alt="ZenYukti Banner" src="https://raw.githubusercontent.com/ZenYukti/zenyukti.github.io/main/public/assets/branding/gh-bright.png" width="800"></picture>'
          
          USER_LOGIN="${{ github.actor }}"
          REPO="${{ github.repository }}"

          # --- LOGIC FOR NEW ISSUE (FIRST TIME) ---
          if [[ "${{ github.event_name }}" == "issues" && "${{ github.event.action }}" == "opened" ]]; then
            # Check if user has other issues in this repo
            COUNT=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/search/issues?q=author:$USER_LOGIN+repo:$REPO+type:issue" | jq '.total_count')
            if [ "$COUNT" -le 1 ]; then
              BODY="$BANNER\n\n## Welcome to the ZenYukti Community! üöÄ\n\nThank you for opening your first issue! We believe every great project starts with a single conversation.\n\n**While you wait:**\n* Check [CONTRIBUTING Guidelines](https://github.com/ZenYukti/.github/blob/main/CONTRIBUTING.md)\n* Join [Discord](https://go.zenyukti.in/discord)"
            fi

          # --- LOGIC FOR NEW PR (FIRST TIME) ---
          elif [[ "${{ github.event_name }}" == "pull_request_target" && "${{ github.event.action }}" == "opened" ]]; then
            # Check if user has other PRs in this repo
            COUNT=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/search/issues?q=author:$USER_LOGIN+repo:$REPO+type:pr" | jq '.total_count')
            if [ "$COUNT" -le 1 ]; then
              BODY="$BANNER\n\n## Yay! You're officially a Contributor! üéâ\n\nHuge thanks for opening your first Pull Request. Being a contributor to ZenYukti is a big deal!\n\n**Next Steps:**\n1. Maintainers will review soon.\n2. Link an assigned issue in the description."
            fi

          # --- LOGIC FOR FIRST PR MERGE ---
          elif [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
            # Check if this is their first merged PR
            COUNT=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/search/issues?q=author:$USER_LOGIN+repo:$REPO+type:pr+is:merged" | jq '.total_count')
            if [ "$COUNT" -eq 1 ]; then
              BODY="## Mission Accomplished! üèÜ\n\nCongratulations on merging your first PR into ZenYukti! Your code is now officially part of the project. Keep the momentum going!"
            fi
          fi

          # --- POST THE COMMENT IF BODY IS SET ---
          if [ ! -z "$BODY" ]; then
            curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$REPO/issues/${{ github.event.issue.number || github.event.pull_request.number }}/comments \
            -d "{\"body\":\"$BODY\"}"
          fi